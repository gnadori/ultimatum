<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ultimatum Game</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container fade-in">
        <div class="admin-header">
            <h1>Ultimátum Játék Admin</h1>
        </div>

        <div class="card">
            <h2>Új Játék Létrehozása</h2>
            <form id="createGameForm">
                <div class="form-group">
                    <label for="totalSum">Teljes Összeg (Amit el kell osztani)</label>
                    <input type="number" id="totalSum" value="100" min="1" required>
                </div>

                <div class="form-group">
                    <label for="rounds">Körök Száma</label>
                    <input type="number" id="rounds" value="1" min="1" required>
                </div>

                <div class="form-group">
                    <label for="roleMode">Szerepkörök</label>
                    <select id="roleMode">
                        <option value="fixed">Fix (1. Játékos mindig Ajánlattevő)</option>
                        <option value="alternating">Váltakozó (Minden körben csere)</option>
                        <option value="random_each_round">Véletlenszerű minden körben</option>
                    </select>
                </div>

                <div class="form-group checkbox-wrapper">
                    <input type="checkbox" id="chatEnabled">
                    <label for="chatEnabled">Chat engedélyezése a játékosok között</label>
                </div>

                <div class="form-group checkbox-wrapper">
                    <input type="checkbox" id="showScore" checked>
                    <label for="showScore">Pontszámok mutatása</label>
                </div>

                <button type="submit" class="btn btn-primary btn-lg">Játék Létrehozása</button>
            </form>
        </div>

        <div class="card">
            <div class="admin-header" style="margin-bottom: 1rem;">
                <h2>Legutóbbi Játékok</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="downloadCsvBtn" class="btn btn-secondary">CSV Letöltés</button>
                    <button id="resetDatabaseBtn" class="btn btn-danger"
                        style="background-color: var(--danger); color: white; border: 1px solid #7f1d1d;">Összes
                        Törlése</button>
                </div>
            </div>
            <div id="gamesList" class="games-list">
                <!-- Game items will be populated here -->
                <div class="game-item" style="justify-content: center; color: var(--text-muted);">
                    Játékok betöltése...
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Config & Logic (Inlined) -->
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCw55eqDs0QJK2bkfoA044vJRqE5uYLXFg",
            authDomain: "ultimatum-game-53dac.firebaseapp.com",
            projectId: "ultimatum-game-53dac",
            storageBucket: "ultimatum-game-53dac.firebasestorage.app",
            messagingSenderId: "526372511794",
            appId: "1:526372511794:web:7ddbda6f991ab2ec445c2b",
            measurementId: "G-DYVYK5L0QP"
        };

        // Initialize Firebase Global
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // FORCE LONG POLLING (Fix for School Firewalls blocking WebSockets)
        db.settings({ experimentalForceLongPolling: true });

        // --- Admin Logic ---
        // No imports needed, we use global 'db'

        const createGameForm = document.getElementById('createGameForm');
        const gamesList = document.getElementById('gamesList');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');

        // Helper to generate a random 6-digit code
        function generateGameCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Create Game Handler
        createGameForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = createGameForm.querySelector('button');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Létrehozás...';

            // Clear previous messages
            const existingSuccess = document.getElementById('successBox');
            if (existingSuccess) existingSuccess.remove();
            const existingError = document.getElementById('errorBox');
            if (existingError) existingError.remove();

            const config = {
                totalSum: Number(document.getElementById('totalSum').value),
                rounds: Number(document.getElementById('rounds').value),
                roleMode: document.getElementById('roleMode').value,
                chatEnabled: document.getElementById('chatEnabled').checked,
                showScore: document.getElementById('showScore').checked
            };

            try {
                const gameCode = generateGameCode();
                console.log("Attempting to create game:", gameCode);

                // Create game document with Timeout
                const createPromise = db.collection("games").add({
                    gameCode: gameCode,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    config: config,
                    status: "waiting",
                    players: [],
                    currentRound: 1,
                    history: [],
                    roundState: {
                        offer: null,
                        decision: null,
                        chatMessages: []
                    }
                });

                // Timeout Promise
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Időtúllépés. Ellenőrizd az internetkapcsolatot vagy a tűzfalat.")), 10000)
                );

                await Promise.race([createPromise, timeoutPromise]);

                console.log("Game document written successfully.");

                // Generate Link Robustly
                let baseUrl = window.location.href;
                // Simple replacements to ensure we point to index.html
                if (baseUrl.includes('admin.html')) {
                    baseUrl = baseUrl.replace('admin.html', 'index.html');
                } else if (baseUrl.endsWith('/')) {
                    baseUrl += 'index.html';
                } else {
                    baseUrl += '/index.html';
                }

                // Clean URL params and hash
                const joinLink = `${baseUrl.split('?')[0].split('#')[0]}?code=${gameCode}`;

                // Success Message UI
                const gameItem = document.createElement('div');
                gameItem.id = 'successBox';
                gameItem.className = 'card';
                gameItem.style.background = 'var(--surface-dark)';
                gameItem.style.border = '2px solid var(--success)';
                gameItem.style.marginTop = '2rem';
                gameItem.innerHTML = `
                    <h3 style="color: var(--success)">Játék Létrehozva!</h3>
                    <p><strong>Kód:</strong> <span style="font-size: 1.5rem;">${gameCode}</span></p>
                    <p style="margin: 0.5rem 0;">
                        <strong>Megosztható link:</strong><br>
                        <a href="${joinLink}" target="_blank" style="color: var(--primary-color); word-break: break-all;">${joinLink}</a>
                    </p>
                `;

                createGameForm.parentNode.insertBefore(gameItem, createGameForm.nextSibling);
                createGameForm.reset();

            } catch (error) {
                console.error("Error creating game: ", error);

                // Error Message UI
                const errDiv = document.createElement('div');
                errDiv.id = 'errorBox';
                errDiv.className = 'card';
                errDiv.style.background = '#3e1b1b';
                errDiv.style.border = '2px solid var(--danger)';
                errDiv.style.marginTop = '2rem';
                errDiv.innerHTML = `
                    <h3 style="color: var(--danger)">Hiba közben</h3>
                    <p>${error.message}</p>
                    <p class="text-muted" style="font-size: 0.9rem;">
                        Lehetséges okok:<br>
                        1. Hiányzó Jogosultságok (Engedélyezted a 'Cloud Firestore'-t?).<br>
                        2. Internet hiba.<br>
                        3. Rossz Firebase Config.
                    </p>
                `;
                createGameForm.parentNode.insertBefore(errDiv, createGameForm.nextSibling);

            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Játék Létrehozása';
            }
        });

        // Listen for Games
        db.collection("games").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            gamesList.innerHTML = '';

            if (snapshot.empty) {
                gamesList.innerHTML = '<div class="game-item" style="justify-content: center;">Nincs elérhető játék.</div>';
                return;
            }

            snapshot.forEach((doc) => {
                const game = doc.data();
                const date = game.createdAt ? game.createdAt.toDate().toLocaleString() : 'Épp most';

                const div = document.createElement('div');
                div.className = 'game-item';
                div.innerHTML = `
                    <div>
                        <strong>Kód: ${game.gameCode}</strong><br>
                        <small class="text-muted">${date}</small>
                    </div>
                    <div style="text-align: right;">
                        <span class="status-badge status-${game.status}">${game.status}</span><br>
                        <small>${game.players ? game.players.length : 0}/2 Játékos</small>
                    </div>
                `;
                gamesList.appendChild(div);
            });
        }, (error) => {
            // Handle snapshot error
            console.error("Snapshot error:", error);
            gamesList.innerHTML = `<div class="game-item" style="color: var(--danger); justify-content: center;">
                Hiba a játékok betöltésekor: ${error.message}<br>
                Ellenőrizd a Firestore Jogosultságokat.
           </div>`;
        });

        // Reset Database Logic
        document.getElementById('resetDatabaseBtn').addEventListener('click', async () => {
            if (!confirm("Biztosan törölni akarod az ÖSSZES játékot? Ez a művelet nem visszavonható!")) {
                return;
            }

            const btn = document.getElementById('resetDatabaseBtn');
            btn.disabled = true;
            btn.textContent = "Törlés...";

            try {
                // Client-side delete all logic (Batching)
                const querySnapshot = await db.collection("games").get();

                if (querySnapshot.empty) {
                    alert("Az adatbázis már üres.");
                    return;
                }

                // Firestore batch limit is 500
                const batch = db.batch();
                querySnapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                alert("Minden játék sikeresen törölve!");

            } catch (e) {
                console.error("Delete error:", e);
                alert("Hiba a törléskor: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "Összes Törlése";
            }
        });

        // CSV Export Logic
        downloadCsvBtn.addEventListener('click', async () => {
            downloadCsvBtn.disabled = true;
            downloadCsvBtn.textContent = "Generálás...";

            try {
                const querySnapshot = await db.collection("games").get();

                let csvContent = "data:text/csv;charset=utf-8,";
                // Header
                csvContent += "JatekID,Datum,TeljesOsszeg,Korok,SzerepMod,KorSzam,AjanlattevoID,ValaszoloID,Ajanlat,Dontes,ChatNaplo\n";

                querySnapshot.forEach((doc) => {
                    const game = doc.data();
                    const date = game.createdAt ? game.createdAt.toDate().toISOString() : '';

                    // If game has history, log each round
                    if (game.history && game.history.length > 0) {
                        game.history.forEach(round => {
                            const chatLogs = round.chatLogs ? round.chatLogs.map(c => `[${c.role}]: ${c.msg}`).join(" | ").replace(/,/g, ";") : "";

                            const row = [
                                game.gameCode,
                                date,
                                game.config.totalSum,
                                game.config.rounds,
                                game.config.roleMode,
                                round.round,
                                round.proposer, // This might be session ID
                                round.responder,
                                round.offer,
                                round.decision,
                                chatLogs
                            ].join(",");
                            csvContent += row + "\n";
                        });
                    }
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "ultimatum_jatek_adatok.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (e) {
                console.error("Export error:", e);
                alert("Sikertelen CSV exportálás: " + e.message);
            } finally {
                downloadCsvBtn.disabled = false;
                downloadCsvBtn.textContent = "CSV Letöltés";
            }
        });
    </script>
</body>

</html>